#' Merge the AZMP and ECOMON \code{C. fin} data for stages 4-6
#' 
#' @param e tibble (not sf), staged ecomon data - see \code{\link{ecomon}{read_staged}}
#' @param a tibble (not sf), staged azmp data - see \code{\link{azmp}{read_calanus}}
#' @param form character, one of 'tibble' or 'sf'
#' @return tibble or sf POINT object
#' \itemize{
#' \item{src one of 'azmp' or 'ecomon'}
#' \item{id combination of cruisename_station}
#' \item{date}
#' \item{season where 1 = DJF, 2 = MAM, 3= JJA, 4 = SON}
#' \item{month month number}
#' \item{longitude negative west, dropped is form is 'sf'}
#' \item{latitude negative south, dropped if form is 'sf'}
#' \item{depth station or sounding depth}
#' \item{abundance count per 1m^2}
#' }
merge_calanus <- function(e = ecomon::read_staged(),
                          a = azmpcfin::read_calanus(),
                          form = c("tibble", "sf")[1]){
  
  e <- dplyr::mutate(e,
      src = "ecomon",               
      id = sprintf("%s_%i", .data$cruise_name, .data$station),
      .before = 1) |>
    dplyr::rename(c(depth = "sta_depth")) |>
    dplyr::mutate(abundance = (.data$c6_10m2 +.data$c5_10m2 + .data$c4_10m2)/10) |>
    dplyr::select(dplyr::all_of(c("src", "id", "date", "longitude", "latitude", 
                                  "depth", "abundance")))
  
  a <- dplyr::mutate(a,
      src = "azmp",
      id = sprintf("%s_%s", .data$transect, .data$station),
      date = as.Date(sprintf("%0.4i-%0.2i-%0.2i", .data$year, .data$month,.data$day)),
      .before = 1) |>
    dplyr::mutate(abundance = (.data$calanus_finmarchicus_iv + 
                                 .data$calanus_finmarchicus_v + 
                                 .data$calanus_finmarchicus_vi)) |>
    dplyr::select(dplyr::all_of(c("src", "id", "date", "longitude", "latitude", 
                                  "depth", "abundance"))) 
    
  x <- dplyr::bind_rows(a, e)
  
  szn <- seq(from = as.Date("1970-12-01"), to = Sys.Date(), by = "3 months")
  szn_names <- rep(1:4, times = length(szn))
  ix <- findInterval(x$date, szn)
  
  x <- dplyr::mutate(x,
    season = szn_names[ix],
    month = as.numeric(format(.data$date, "%m")),
    .after = dplyr::all_of("date"))
  
  if (tolower(form[1]) == "sf"){
    x <- sf::st_as_sf(x, coords = c("longitude", "latitude"), crs = 4326)
  }
  x
}

# Rows: 7,802
# Columns: 30
# $ region                   <chr> "QC", "QC", "QC", "QC", "QC", "QC", "QC", "QC", "QC"…
# $ transect                 <chr> "TSI", "TSI", "TSI", "TESL", "TESL", "TESL", "TESL",…
# $ station                  <chr> "TSI3", "TSI5", "TSI6", "TESL1", "TESL2", "TESL3", "…
# $ year                     <dbl> 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000…
# $ month                    <dbl> 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, …
# $ day                      <dbl> 3, 3, 3, 4, 4, 4, 4, 4, 4, 4, 5, 5, 5, 5, 6, 6, 30, …
# $ time                     <time> 22:55:00, 19:17:00, 17:28:00, 14:21:00, 15:45:00, 1…
# $ timezone                 <chr> "UTC", "UTC", "UTC", "UTC", "UTC", "UTC", "UTC", "UT…
# $ longitude                <dbl> -66.22983, -66.27050, -66.27500, -68.48500, -68.5470…
# $ latitude                 <dbl> 49.55117, 49.88333, 50.05333, 48.57583, 48.62750, 48…
# $ depth                    <dbl> 340, 276, 121, 38, 225, 331, 339, 341, 149, 342, 235…
# $ mesh_size                <dbl> 202, 202, 202, 202, 202, 202, 202, 202, 202, 202, 20…
# $ calanus_finmarchicus_i   <dbl> 223.02556, 178.40076, 711.74097, 387.92602, 90.54150…
# $ calanus_finmarchicus_ii  <dbl> 223.02556, 356.80153, 1245.54670, 77.58520, 0.00000,…
# $ calanus_finmarchicus_iii <dbl> 1115.127790, 1427.206117, 711.740970, 232.755610, 0.…
# $ calanus_finmarchicus_iv  <dbl> 4460.511161, 1962.408410, 1067.611456, 439.649486, 3…
# $ calanus_finmarchicus_v   <dbl> 35015.01262, 14093.66040, 1067.61146, 51.72347, 8601…
# $ calanus_finmarchicus_vi  <dbl> 1784.20446, 178.40076, 355.87049, 51.72347, 362.1660…
# $ calanus_glacialis_i      <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
# $ calanus_glacialis_ii     <dbl> 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.00…
# $ calanus_glacialis_iii    <dbl> 0.00000, 0.00000, 0.00000, 0.00000, 0.00000, 0.00000…
# $ calanus_glacialis_iv     <dbl> 0.00000, 0.00000, 177.93524, 0.00000, 0.00000, 0.000…
# $ calanus_glacialis_v      <dbl> 446.05112, 178.40076, 0.00000, 0.00000, 452.70750, 0…
# $ calanus_glacialis_vi     <dbl> 1115.12779, 535.20229, 0.00000, 0.00000, 1448.66400,…
# $ calanus_hyperboreus_i    <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
# $ calanus_hyperboreus_ii   <dbl> 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.00…
# $ calanus_hyperboreus_iii  <dbl> 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.…
# $ calanus_hyperboreus_iv   <dbl> 8697.996764, 1962.408410, 177.935243, 0.000000, 1086…
# $ calanus_hyperboreus_v    <dbl> 10482.20123, 3389.61453, 177.93524, 25.86173, 814.87…
# $ calanus_hyperboreus_vi   <dbl> 3122.35781, 1070.40459, 0.00000, 0.00000, 181.08300,…



# > glimpse(e)
# Rows: 24,387
# Columns: 18
# $ seq                  <dbl> 23221, 23222, 23223, 23224, 23225, 23226, 23227, 23228, …
# $ cruise_name          <chr> "MM7701", "MM7701", "MM7701", "MM7701", "MM7701", "MM770…
# $ station              <dbl> 2, 3, 5, 7, 8, 9, 15, 16, 19, 20, 23, 26, 29, 33, 35, 36…
# $ latitude             <dbl> 41.1833, 41.0167, 41.0000, 40.5167, 40.2667, 40.1500, 40…
# $ longitude            <dbl> -70.6667, -70.6667, -71.5000, -71.0167, -71.5000, -71.75…
# $ date                 <date> 1977-02-13, 1977-02-13, 1977-02-13, 1977-02-13, 1977-02…
# $ sta_depth            <dbl> 33, 48, 49, 77, 84, 84, 91, 152, 109, 73, 62, 65, 46, 73…
# $ tow_depth            <dbl> 25, 43, 38, 77, 78, 74, 90, 112, 87, 63, 56, 63, 40, 65,…
# $ gear_volume_filtered <dbl> 222.702, 222.539, 296.209, 500.050, 654.279, 664.187, 81…
# $ zoo_aliquot          <dbl> 256, 256, 256, 512, 512, 256, 512, 64, 64, 256, 256, 256…
# $ total_10m2           <dbl> 287.38, 494.65, 656.83, 1576.80, 2441.53, 570.44, 47016.…
# $ c6_10m2              <dbl> 287.3795, 0.0000, 656.8335, 788.4012, 1831.1454, 570.441…
# $ c5_10m2              <dbl> 0.0000, 0.0000, 0.0000, 788.4012, 610.3818, 0.0000, 9629…
# $ c4_10m2              <dbl> 0.00000, 494.65487, 0.00000, 0.00000, 0.00000, 0.00000, …
# $ c3_10m2              <dbl> 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, …
# $ c2_10m2              <dbl> 0.00000, 0.00000, 0.00000, 0.00000, 0.00000, 0.00000, 0.…
# $ c1_10m2              <dbl> 0.00000, 0.00000, 0.00000, 0.00000, 0.00000, 0.00000, 0.…
# $ unk_10m2             <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…

